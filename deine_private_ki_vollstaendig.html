<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deine Private KI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    class AIApp {
      constructor() {
        this.messages = [];
        this.currentTab = 'chat';
        this.loading = false;
        this.generatingImage = false;
        this.generatedImage = null;
        this.imagePrompt = '';
        this.input = '';
        // Hinweis: Token in Klartext ist unsicher. F√ºr maximale Sicherheit: Server/Proxy nutzen.
        this.token = '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';
        this.init();
      }

      init() {
        this.loadMessages();
        this.render();
      }

      loadMessages() {
        const saved = localStorage.getItem('chat-history');
        if (saved) {
          try {
            this.messages = JSON.parse(saved) || [];
          } catch (_) {
            this.messages = [];
          }
        }
      }

      saveMessages() {
        localStorage.setItem('chat-history', JSON.stringify(this.messages));
      }

      async sendMessage() {
        if (this.loading) return;

        const text = (this.input || '').trim();
        if (!text) return;

        const userMsg = text;
        this.input = '';
        this.messages.push({ role: 'user', content: userMsg });
        this.saveMessages();

        this.loading = true;
        this.render();

        try {
          const response = await fetch(
            'https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.1',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`,
              },
              body: JSON.stringify({
                inputs: userMsg,
                parameters: {
                  max_new_tokens: 500,
                  temperature: 0.7,
                },
              }),
            }
          );

          const data = await response.json();

          // HF kann unterschiedliche Response-Formate liefern (Objekt/Array/Error)
          let aiResponse = 'Entschuldigung, ich konnte keine Antwort generieren.';
          if (Array.isArray(data) && data[0] && typeof data[0].generated_text === 'string') {
            aiResponse = data[0].generated_text;
          } else if (data && typeof data.generated_text === 'string') {
            aiResponse = data.generated_text;
          } else if (data && data.error) {
            aiResponse = `‚ö†Ô∏è Fehler: ${data.error}`;
          }

          this.messages.push({ role: 'assistant', content: aiResponse });
        } catch (error) {
          this.messages.push({
            role: 'assistant',
            content: '‚ö†Ô∏è Fehler: Die KI antwortet momentan nicht. Bitte sp√§ter erneut versuchen.',
          });
        }

        this.saveMessages();
        this.loading = false;
        this.render();
        this.scrollToBottom();
      }

      async generateImage() {
        if (this.generatingImage) return;

        const prompt = (this.imagePrompt || '').trim();
        if (!prompt) return;

        this.generatingImage = true;
        this.render();

        try {
          const response = await fetch(
            'https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-2-1',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`,
              },
              body: JSON.stringify({ inputs: prompt }),
            }
          );

          // Wenn HF eine Fehlermeldung als JSON zur√ºckgibt, nicht als Bild interpretieren
          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            const err = await response.json();
            throw new Error(err?.error || 'Unbekannter Fehler beim Bild-Request.');
          }

          const blob = await response.blob();
          this.generatedImage = URL.createObjectURL(blob);
        } catch (error) {
          alert('Fehler beim Generieren des Bildes: ' + (error?.message || 'Bitte sp√§ter versuchen.'));
        }

        this.generatingImage = false;
        this.render();
      }

      downloadImage() {
        if (!this.generatedImage) return;
        const link = document.createElement('a');
        link.href = this.generatedImage;
        link.download = 'generated-image.png';
        document.body.appendChild(link);
        link.click();
        link.remove();
      }

      clearChat() {
        if (confirm('Chat wirklich l√∂schen?')) {
          this.messages = [];
          this.saveMessages();
          this.render();
        }
      }

      scrollToBottom() {
        setTimeout(() => {
          const chatDiv = document.querySelector('[data-chat-messages]');
          if (chatDiv) {
            chatDiv.scrollTop = chatDiv.scrollHeight;
          }
        }, 50);
      }

      render() {
        const app = document.getElementById('app');
        app.innerHTML = `
          <div class="flex h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            <!-- Sidebar -->
            <div class="w-64 bg-slate-950 border-r border-slate-700 p-6 flex flex-col">
              <h1 class="text-2xl font-bold text-white mb-8 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Deine KI
              </h1>

              <div class="space-y-3 mb-8">
                <button data-tab="chat"
                  class="w-full py-3 px-4 rounded-lg font-medium transition ${
                    this.currentTab === 'chat'
                      ? 'bg-blue-600 text-white'
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  }">
                  üí¨ Chat
                </button>
                <button data-tab="image"
                  class="w-full py-3 px-4 rounded-lg font-medium transition ${
                    this.currentTab === 'image'
                      ? 'bg-purple-600 text-white'
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  }">
                  üñºÔ∏è Bilder
                </button>
              </div>

              ${
                this.currentTab === 'chat'
                  ? `<button data-clear-chat
                      class="mt-auto w-full py-2 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
                      üóëÔ∏è Chat l√∂schen
                    </button>`
                  : `<div class="mt-auto"></div>`
              }

              <div class="mt-8 p-4 bg-slate-800 rounded-lg text-xs text-slate-400 border border-slate-700">
                <p class="font-semibold text-slate-300 mb-2">‚ÑπÔ∏è Info</p>
                <p>Diese KI l√§uft kostenlos auf Hugging Face. Deine Chats werden lokal gespeichert.</p>
              </div>
            </div>

            <!-- Hauptbereich -->
            <div class="flex-1 flex flex-col">
              ${this.currentTab === 'chat' ? this.renderChat() : this.renderImage()}
            </div>
          </div>
        `;

        // Tabs
        app.querySelectorAll('[data-tab]').forEach((btn) => {
          btn.addEventListener('click', () => {
            this.currentTab = btn.getAttribute('data-tab');
            this.render();
          });
        });

        // Chat l√∂schen
        const clearBtn = app.querySelector('[data-clear-chat]');
        if (clearBtn) clearBtn.addEventListener('click', () => this.clearChat());

        // Chat input bindings
        const inputEl = app.querySelector('[data-chat-input]');
        const sendBtn = app.querySelector('[data-send-btn]');
        if (inputEl) {
          inputEl.value = this.input || '';
          inputEl.addEventListener('input', (e) => {
            this.input = e.target.value;
          });
          inputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !this.loading) {
              this.sendMessage();
            }
          });
        }
        if (sendBtn) {
          sendBtn.addEventListener('click', () => this.sendMessage());
        }

        // Image prompt bindings
        const promptEl = app.querySelector('[data-image-prompt]');
        const genBtn = app.querySelector('[data-generate-image]');
        const dlBtn = app.querySelector('[data-download-image]');
        if (promptEl) {
          promptEl.value = this.imagePrompt || '';
          promptEl.addEventListener('input', (e) => {
            this.imagePrompt = e.target.value;
          });
        }
        if (genBtn) genBtn.addEventListener('click', () => this.generateImage());
        if (dlBtn) dlBtn.addEventListener('click', () => this.downloadImage());

        this.scrollToBottom();
      }

      renderChat() {
        return `
          <div class="flex-1 overflow-y-auto p-8 space-y-4" data-chat-messages>
            ${
              this.messages.length === 0
                ? `
                  <div class="h-full flex items-center justify-center">
                    <div class="text-center">
                      <h2 class="text-3xl font-bold text-white mb-4">Willkommen! üëã</h2>
                      <p class="text-slate-400 mb-6">Starte ein Gespr√§ch mit deiner KI</p>
                    </div>
                  </div>
                `
                : `
                  ${this.messages
                    .map(
                      (msg) => `
                        <notice class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                          <div class="max-w-xl px-6 py-4 rounded-lg ${
                            msg.role === 'user'
                              ? 'bg-blue-600 text-white rounded-br-none'
                              : 'bg-slate-700 text-slate-100 rounded-bl-none'
                          }">
                            <p class="whitespace-pre-wrap">${this.escapeHtml(msg.content)}</p>
                          </div>
                        </notice>
                      `
                    )
                    .join('')}
                `
            }
            ${
              this.loading
                ? `
                  <div class="flex justify-start">
                    <div class="bg-slate-700 text-slate-100 px-6 py-4 rounded-lg rounded-bl-none">
                      ‚è≥ KI denkt...
                    </div>
                  </div>
                `
                : ''
            }
          </div>

          <div class="border-t border-slate-700 p-6 bg-slate-850">
            <div class="flex gap-3">
              <input type="text" data-chat-input
                placeholder="Schreib deine Frage..."
                class="flex-1 px-4 py-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none placeholder-slate-400"
              />
              <button data-send-btn ${this.loading ? 'disabled' : ''}
                class="px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 text-white rounded-lg transition font-medium">
                ‚û§ Senden
              </button>
            </div>
          </div>
        `;
      }

      renderImage() {
        return `
          <div class="flex-1 overflow-y-auto p-8">
            <div class="max-w-2xl mx-auto">
              <h2 class="text-3xl font-bold text-white mb-8">Bilder generieren</h2>

              <div class="space-y-6">
                <div>
                  <label class="block text-white font-medium mb-3">
                    Beschreib das Bild, das du m√∂chtest
                  </label>
                  <textarea data-image-prompt
                    placeholder="z.B. 'Ein futuristisches Raumschiff √ºber einer gl√ºhenden Stadt, 4K'"
                    class="w-full px-4 py-3 bg-slate-700 text-white rounded-lg border border-slate-600 focus:border-purple-500 focus:outline-none placeholder-slate-400 h-24 resize-none"
                  ></textarea>
                </div>

                <button data-generate-image ${this.generatingImage ? 'disabled' : ''}
                  class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-600 text-white rounded-lg transition font-medium">
                  ${this.generatingImage ? '‚è≥ Generiert...' : 'üñºÔ∏è Bild generieren'}
                </button>

                ${
                  this.generatedImage
                    ? `
                      <div class="space-y-4">
                        <img src="${this.generatedImage}" alt="Generated" class="w-full rounded-lg border border-slate-600" />
                        <button data-download-image
                          class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition font-medium">
                          ‚¨áÔ∏è Herunterladen
                        </button>
                      </div>
                    `
                    : ''
                }
              </div>
            </div>
          </div>
        `;
      }

      escapeHtml(str) {
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }
    }

    window.app = new AIApp();
  </script>
</body>
</html>
