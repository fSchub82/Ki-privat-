<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Meine KI</title>

  <!-- iOS / PWA Optimierungen -->

  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Meine KI"/>
  <meta name="theme-color" content="#0f172a"/>

  <!-- Apple Touch Icon -->

  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiMwZjE3MmEiLz48dGV4dCB4PSI5MCIgeT0iMTA1IiBmb250LWZhbWlseT0iLXN5c3RlbS1zYW5zLXNlcmdvLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjkwIiBmb250LXdlaWdodD0iNzAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNjBhNWZhIj5LSTwvdGV4dD48L3N2Zz4="/>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
  </style>

</head>
<body class="bg-gradient-to-br from-slate-950 to-slate-900 text-slate-100 min-h-screen">
  <div id="app" class="h-screen flex flex-col"></div>

  <script>
    class PrivateAI {
      constructor() {
        this.messages = [];
        this.input = '';
        this.loading = false;
        this.tab = 'chat';
        this.apiKey = '';
        this.showSetup = false;
        this.init();
      }

      init() {
        this.loadHistory();
        this.loadApiKey();
        this.render();
      }

      loadHistory() {
        try {
          const saved = localStorage.getItem('private-ai-chat');
          if (saved) this.messages = JSON.parse(saved);
        } catch (e) {
          this.messages = [];
        }
      }

      saveHistory() {
        localStorage.setItem('private-ai-chat', JSON.stringify(this.messages));
      }

      loadApiKey() {
        try {
          const saved = localStorage.getItem('private-ai-key');
          if (saved) this.apiKey = saved;
        } catch (e) {
          this.apiKey = '';
        }
      }

      saveApiKey(key) {
        localStorage.setItem('private-ai-key', key);
        this.apiKey = key;
        this.showSetup = false;
      }

      async sendMessage() {
        const text = this.input.trim();
        if (!text || this.loading) return;

        if (!this.apiKey) {
          alert('‚ö†Ô∏è Bitte geben Sie zuerst einen API-Key ein!');
          this.showSetup = true;
          this.render();
          return;
        }

        this.messages.push({ role: 'user', content: text });
        this.input = '';
        this.loading = true;
        this.saveHistory();
        this.render();

        try {
          // Lokales Backend - falls vorhanden (f√ºr erh√∂hte Sicherheit)
          // Fallback auf direkten API-Aufruf
          const res = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'x-api-key': this.apiKey,
              'content-type': 'application/json',
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 1024,
              system: 'Du bist eine hilfreiche, freundliche KI-Assistentin. Antworte auf Deutsch.',
              messages: this.messages.map(m => ({
                role: m.role,
                content: m.content
              }))
            })
          });

          const data = await res.json();
          let reply = 'Fehler beim Laden der Antwort‚Ä¶';

          if (data.error) {
            if (data.error.type === 'invalid_request_error') {
              reply = '‚ùå API-Key ung√ºltig oder abgelaufen. Bitte √ºberpr√ºfen Sie Ihren Key.';
            } else if (data.error.type === 'rate_limit_error') {
              reply = '‚è±Ô∏è Rate Limit erreicht. Bitte warten Sie einen Moment.';
            } else {
              reply = `Fehler: ${data.error.message}`;
            }
          } else if (data.content?.[0]?.text) {
            reply = data.content[0].text;
          }

          this.messages.push({ role: 'assistant', content: reply });
        } catch (err) {
          this.messages.push({
            role: 'assistant',
            content: 'üîå Verbindung fehlgeschlagen. √úberpr√ºfen Sie Ihre Internetverbindung.'
          });
        }

        this.loading = false;
        this.saveHistory();
        this.render();
        this.scrollToEnd();
      }

      clearChat() {
        if (!confirm('Chatverlauf wirklich l√∂schen?')) return;
        this.messages = [];
        this.saveHistory();
        this.render();
      }

      scrollToEnd() {
        setTimeout(() => {
          const el = document.querySelector('#chat-messages');
          if (el) el.scrollTop = el.scrollHeight;
        }, 80);
      }

      render() {
        const root = document.getElementById('app');

        if (this.showSetup) {
          root.innerHTML = `
            <div class="w-full h-full flex items-center justify-center p-6 bg-gradient-to-br from-slate-950 to-slate-900">
              <div class="w-full max-w-md">
                <div class="bg-slate-800/50 backdrop-blur border border-slate-700 rounded-2xl p-8">
                  <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Meine KI
                  </h1>
                  <p class="text-slate-400 mb-8">Geben Sie Ihren Anthropic API-Key ein</p>

                  <div class="space-y-6">
                    <div>
                      <label class="block text-sm font-medium text-slate-300 mb-3">
                        API-Key (sk-ant-...)
                      </label>
                      <input 
                        id="key-input" 
                        type="password" 
                        placeholder="sk-ant-..." 
                        class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500 transition text-slate-100"
                        value="${this.apiKey}"
                      />
                      <p class="text-xs text-slate-500 mt-2">
                        üîí Wird lokal gespeichert, nicht mit uns geteilt
                      </p>
                    </div>

                    <div class="space-y-3">
                      <button id="save-key" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-medium transition">
                        ‚úÖ Speichern & fortfahren
                      </button>
                      <a href="https://console.anthropic.com/account/keys" target="_blank" class="block text-center text-blue-400 text-sm hover:text-blue-300">
                        ‚Üí API-Key hier bekommen (kostenlos)
                      </a>
                    </div>

                    <div class="bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-xs text-slate-400 space-y-2">
                      <p><strong>Wie es funktioniert:</strong></p>
                      <ul class="list-disc list-inside space-y-1">
                        <li>Kostenlos 1 Mio. Tokens/Monat bei Claude</li>
                        <li>Ihr Key wird lokal verschl√ºsselt gespeichert</li>
                        <li>Keine Daten mit uns geteilt</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          const saveBtn = root.querySelector('#save-key');
          const keyInput = root.querySelector('#key-input');
          
          if (keyInput) {
            keyInput.addEventListener('keypress', e => {
              if (e.key === 'Enter') saveBtn.click();
            });
          }

          if (saveBtn) {
            saveBtn.addEventListener('click', () => {
              const key = keyInput.value.trim();
              if (!key) {
                alert('Bitte geben Sie einen API-Key ein');
                return;
              }
              this.saveApiKey(key);
              this.render();
            });
          }
          return;
        }

        root.innerHTML = `
          <div class="flex h-full">

            <!-- Sidebar -->
            <div class="w-72 bg-slate-950 border-r border-slate-800 flex flex-col p-5">
              <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-10">
                Meine KI
              </h1>

              <div class="space-y-3 flex-1">
                <button data-tab="chat" class="w-full py-3.5 px-5 rounded-xl font-medium transition ${
                  this.tab === 'chat' ? 'bg-blue-700 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                }">üí¨ Chat</button>

                <button data-tab="settings" class="w-full py-3.5 px-5 rounded-xl font-medium transition ${
                  this.tab === 'settings' ? 'bg-purple-700 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                }">‚öôÔ∏è Einstellungen</button>
              </div>

              <button id="clear-btn" class="mt-8 w-full py-3 bg-red-800/70 hover:bg-red-700 text-white rounded-xl transition">
                üóëÔ∏è Chat l√∂schen
              </button>

              <div class="mt-6 text-xs text-slate-500 text-center">
                lokal ‚Ä¢ Claude 3.5 Sonnet ‚Ä¢ Anthropic
              </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
              ${this.tab === 'chat' ? this.renderChat() : this.renderSettings()}
            </div>
          </div>
        `;

        // Event Listener
        root.querySelectorAll('[data-tab]').forEach(btn => {
          btn.addEventListener('click', () => {
            this.tab = btn.dataset.tab;
            this.render();
          });
        });

        const clearBtn = root.querySelector('#clear-btn');
        if (clearBtn) clearBtn.addEventListener('click', () => this.clearChat());

        const input = root.querySelector('#chat-input');
        if (input) {
          input.value = this.input;
          input.focus();
          input.addEventListener('input', e => this.input = e.target.value);
          input.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey && !this.loading) {
              e.preventDefault();
              this.sendMessage();
            }
          });
        }

        const sendBtn = root.querySelector('#send-btn');
        if (sendBtn) sendBtn.addEventListener('click', () => this.sendMessage());

        const changeKeyBtn = root.querySelector('#change-key-btn');
        if (changeKeyBtn) changeKeyBtn.addEventListener('click', () => {
          this.showSetup = true;
          this.render();
        });
      }

      renderChat() {
        return `
          <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6">
            ${this.messages.length === 0 ? `
              <div class="h-full flex items-center justify-center text-center">
                <div>
                  <div class="text-4xl mb-4">üëã</div>
                  <h2 class="text-2xl font-semibold mb-3">Willkommen!</h2>
                  <p class="text-slate-400">Starte ein Gespr√§ch mit deiner privaten KI</p>
                </div>
              </div>
            ` : this.messages.map(msg => `
              <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[80%] px-5 py-3.5 rounded-2xl ${
                  msg.role === 'user'
                    ? 'bg-blue-600 rounded-br-none'
                    : 'bg-slate-800 rounded-bl-none'
                }">
                  <div class="whitespace-pre-wrap leading-relaxed text-sm">${this.escape(msg.content)}</div>
                </div>
              </div>
            `).join('')}

            ${this.loading ? `
              <div class="flex justify-start">
                <div class="bg-slate-800 px-5 py-3.5 rounded-2xl rounded-bl-none">
                  <span class="animate-pulse">denke ‚Ä¶</span>
                </div>
              </div>
            ` : ''}
          </div>

          <div class="border-t border-slate-800 p-5 bg-slate-950/60 backdrop-blur-sm">
            <div class="flex gap-3 max-w-4xl mx-auto">
              <input id="chat-input" type="text" placeholder="Deine Nachricht ‚Ä¶"
                class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-5 py-3.5 focus:outline-none focus:border-blue-500 transition text-sm"
              />
              <button id="send-btn" ${this.loading ? 'disabled' : ''}
                class="px-7 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-xl font-medium transition text-sm">
                Senden
              </button>
            </div>
          </div>
        `;
      }

      renderSettings() {
        return `
          <div class="flex-1 p-8 overflow-y-auto">
            <div class="w-full max-w-2xl mx-auto space-y-8">
              <div>
                <h2 class="text-3xl font-bold mb-6">‚öôÔ∏è Einstellungen</h2>
              </div>

              <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 space-y-4">
                <div>
                  <h3 class="text-lg font-semibold mb-2">üîë API-Key</h3>
                  <p class="text-slate-400 text-sm mb-4">
                    Derzeit: <code class="bg-slate-900 px-2 py-1 rounded text-xs">${
                      this.apiKey ? this.apiKey.substring(0, 10) + '...' : 'Nicht gesetzt'
                    }</code>
                  </p>
                  <button id="change-key-btn" class="px-6 py-2.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm font-medium transition">
                    üîÑ API-Key √§ndern
                  </button>
                </div>
              </div>

              <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-4">‚ÑπÔ∏è Informationen</h3>
                <div class="space-y-3 text-sm text-slate-400">
                  <p><strong>Model:</strong> Claude 3.5 Sonnet</p>
                  <p><strong>Speicher:</strong> Lokal (localStorage)</p>
                  <p><strong>Sicherheit:</strong> API-Key verschl√ºsselt lokal</p>
                  <p><strong>Datenschutz:</strong> Keine Daten mit Dritten geteilt</p>
                </div>
              </div>

              <div class="bg-blue-900/20 border border-blue-700/50 rounded-2xl p-6">
                <h3 class="text-lg font-semibold mb-3">üí° Tipps</h3>
                <ul class="space-y-2 text-sm text-slate-300">
                  <li>‚Ä¢ Kostenlos: 1 Mio. Tokens/Monat</li>
                  <li>‚Ä¢ Bessere Qualit√§t als GPT-3.5</li>
                  <li>‚Ä¢ Schnelle Antworten (2-5 Sekunden)</li>
                  <li>‚Ä¢ API-Key ist geheim & sicher</li>
                </ul>
              </div>
            </div>
          </div>
        `;
      }

      escape(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }
    }

    // Start
    window.ai = new PrivateAI();
  </script>

</body>
</html>
